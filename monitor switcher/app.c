/*
 *                    ~|  DreamControlSwitcher |~
 * 
 *           4-way USB-MIDI Balanced Passive Monitor Switcher
 *
 * ==========================================================================
 *
 *  Copyright (C) 2018 Dave Evans (dave@propertech.co.uk)
 *  Licensed for personal non-commercial use only. All other rights reserved.
 * 
 * ==========================================================================
 */

/////////////////////////////////////////////////////////////////////////////
// Include files
/////////////////////////////////////////////////////////////////////////////

#include <mios32.h>

#include "app.h"

/////////////////////////////////////////////////////////////////////////////
// Globals
/////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////
// Local definitions
/////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////
// Local variables
/////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////
// This hook is called after startup to initialize the application
/////////////////////////////////////////////////////////////////////////////
void APP_Init(void)
{
    MIOS32_BOARD_Init(0);
    MIOS32_BOARD_LED_Init(0xffffffff);

    // Init 8x J10A pins to be push-pull outputs.
    // Our 4 relay groups are connected to J10A pins 0,2,4,6.
    int i;
    for (i = 0; i < 8; i++)
    {
        MIOS32_BOARD_J10_PinInit(i, MIOS32_BOARD_PIN_MODE_OUTPUT_PP);
        MIOS32_BOARD_J10_PinSet(i, 1);
    }

    // Blue LED on CPU board to show Init was completed successfully.
    MIOS32_BOARD_LED_Set(0x0008, 0x0008);  
}

/////////////////////////////////////////////////////////////////////////////
// This task is running in the background
/////////////////////////////////////////////////////////////////////////////
void APP_Background(void)
{

}

/////////////////////////////////////////////////////////////////////////////
// This hook is called each mS from the main task
/////////////////////////////////////////////////////////////////////////////
void APP_Tick(void)
{

}

/////////////////////////////////////////////////////////////////////////////
// This hook is called each mS from the MIDI task
/////////////////////////////////////////////////////////////////////////////
void APP_MIDI_Tick(void)
{

}

/////////////////////////////////////////////////////////////////////////////
// This hook is called when a MIDI package has been received
/////////////////////////////////////////////////////////////////////////////
void APP_MIDI_NotifyPackage(mios32_midi_port_t port, mios32_midi_package_t midi_package)
{
    // Toggle Status LED on MIDI received.
    MIOS32_BOARD_LED_Set(0x0001, ~MIOS32_BOARD_LED_Get());

    if (port == USB0 
        && midi_package.chn == Chn1 
        && midi_package.type == NoteOn 
        && midi_package.note < 5)
    {
        int i;
        for (i = 0; i < 8; i++)
        {
            MIOS32_BOARD_J10_PinSet(i, 1);
        }

        if (midi_package.note > 0) 
        {
            MIOS32_BOARD_J10_PinSet((midi_package.note - 1) * 2, 0);
        }
    }
}

/////////////////////////////////////////////////////////////////////////////
// This hook is called before the shift register chain is scanned
/////////////////////////////////////////////////////////////////////////////
void APP_SRIO_ServicePrepare(void)
{
}

/////////////////////////////////////////////////////////////////////////////
// This hook is called after the shift register chain has been scanned
/////////////////////////////////////////////////////////////////////////////
void APP_SRIO_ServiceFinish(void)
{
}

/////////////////////////////////////////////////////////////////////////////
// This hook is called when a button has been toggled.
// pin_value is 1 when button released, and 0 when button pressed
/////////////////////////////////////////////////////////////////////////////
void APP_DIN_NotifyToggle(u32 pin, u32 pin_value)
{
}

/////////////////////////////////////////////////////////////////////////////
// This hook is called when an encoder has been moved
// incrementer is positive when encoder has been turned clockwise, else
// it is negative
/////////////////////////////////////////////////////////////////////////////
void APP_ENC_NotifyChange(u32 encoder, s32 incrementer)
{
}

 void APP_AIN_NotifyChange(u32 pin, u32 pin_value)
 {
 }
